# VPA

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ **–ø–æ–¥–±–∏—Ä–∞–µ—Ç CPU / memory requests** Pod‚Äô–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è.
* –ù–µ –∏–∑–º–µ–Ω—è–µ—Ç requests/limits –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ Deployment
* Request - —Ä–µ—Å—É—Ä—Å—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω—É–∂–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã, –≤—ã—à–µ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ.
* **–ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç —Ä–µ–ø–ª–∏–∫–∏** (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç HPA).
* –†–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏** (Deployment, StatefulSet –∏ —Ç.–¥.).

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

* **–û–±—è–∑–∞—Ç–µ–ª–µ–Ω `metrics-server`**
* –ë–µ–∑ –º–µ—Ç—Ä–∏–∫ VPA **–Ω–µ –¥–∞—ë—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π**

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (—Ç–∏–ø–∏—á–Ω–æ –¥–ª—è —ç–∫–∑–∞–º–µ–Ω–∞)

–ß–µ—Ä–µ–∑ Helm (–±—ã—Å—Ç—Ä–æ –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è CKA):

```sh
git clone https://github.com/kubernetes/autoscaler.git --depth=1
cd autoscaler/vertical-pod-autoscaler/charts/vertical-pod-autoscaler
helm install vpa vertical-pod-autoscaler -n vpa --create-namespace
```

---

## Update modes (–í–ê–ñ–ù–û –¥–ª—è CKA)

> –†–µ–∂–∏–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç **–∫–∞–∫ VPA –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**

### `Off`

* ‚ùó **–¢–æ–ª—å–∫–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**
* –ù–µ –∏–∑–º–µ–Ω—è–µ—Ç Pods
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏

### `Initial`

* –ü—Ä–∏–º–µ–Ω—è–µ—Ç requests **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pod**
* –£–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ Pod‚Äô—ã **–Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç**
* –ë–µ–∑ eviction ‚Üí –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º

### `Recreate`

* –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ **—á–µ—Ä–µ–∑ eviction Pod‚Äô–æ–≤**
* Pod —É–¥–∞–ª—è–µ—Ç—Å—è –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ requests
* –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ ¬´—Å—Ç–∞—Ä–æ–º—É Auto¬ª

### `InPlaceOrRecreate`

* üîπ **–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º**
* –ü—ã—Ç–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã **in-place**
* –ï—Å–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ ‚Üí –¥–µ–ª–∞–µ—Ç eviction
* –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç —Ä–µ—Å—Ç–∞—Ä—Ç—ã

### `Auto` (**deprecated**)

* –£—Å—Ç–∞—Ä–µ–≤—à–∏–π alias
* –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤–µ–¥—ë—Ç —Å–µ–±—è –∫–∞–∫ `Recreate`
* ‚ùå **–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –Ω–æ–≤—ã—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö**
* –ù–∞ CKA –ª—É—á—à–µ **–Ω–µ –ø–∏—Å–∞—Ç—å**

üìå **CKA —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:

> –ò—Å–ø–æ–ª—å–∑—É–π `Initial` –∏–ª–∏ `InPlaceOrRecreate`

---

## `controlledValues`

### `RequestsOnly` ‚úÖ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

* VPA —É–ø—Ä–∞–≤–ª—è–µ—Ç **—Ç–æ–ª—å–∫–æ requests**
* Limits –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
* **–°–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –æ–∂–∏–¥–∞–µ–º—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞ —ç–∫–∑–∞–º–µ–Ω–µ**

### `RequestsAndLimits` ‚ö†Ô∏è (–æ–ø–∞—Å–Ω–æ)

* VPA –º–µ–Ω—è–µ—Ç **–∏ requests, –∏ limits**
* –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:

  * CPU throttling
  * OOMKill
  * –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
* ‚ùå –û–±—ã—á–Ω–æ **–Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞ CKA**

---

## –ü—Ä–∏–º–µ—Ä VPA (—ç–∫–∑–∞–º–µ–Ω-safe)

```yaml
apiVersion: autoscaling.k8s.io/v1        # API –≥—Ä—É–ø–ø—ã VPA
kind: VerticalPodAutoscaler              # –†–µ—Å—É—Ä—Å VPA
metadata:
  name: nginx-vpa                        # –ò–º—è VPA
  namespace: stage                       # Namespace target workload
spec:
  targetRef:                             # –ö –∫–∞–∫–æ–º—É –æ–±—ä–µ–∫—Ç—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
    apiVersion: apps/v1                  # API target
    kind: Deployment                     # –¢–∏–ø –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
    name: nginx                          # –ò–º—è Deployment
  updatePolicy:
    updateMode: Initial                  # –ë–µ–∑ eviction (–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è CKA)
  resourcePolicy:
    containerPolicies:
    - containerName: nginx               # –î–û–õ–ñ–ù–û —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      minAllowed:
        cpu: 100m                        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π CPU request
        memory: 128Mi                    # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π memory request
      maxAllowed:
        cpu: "2"                         # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π CPU request
        memory: 2Gi                      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π memory request
      controlledResources:
      - cpu                              # –£–ø—Ä–∞–≤–ª—è–µ–º CPU
      - memory                           # –£–ø—Ä–∞–≤–ª—è–µ–º memory
      controlledValues: RequestsOnly     # –£–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ requests
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```sh
kubectl describe vpa nginx-vpa -n stage
```

* `Status: RecommendationProvided` ‚Üí –º–µ—Ç—Ä–∏–∫–∏ –µ—Å—Ç—å
* `Events: EvictedPod` ‚Üí eviction –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª
* `status.recommendation` ‚Üí —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á—ë—Ç—ã VPA
---

## HPA + VPA

* HPA ‚Üí –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç **—Ä–µ–ø–ª–∏–∫–∏**
* VPA ‚Üí –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç **—Ä–µ—Å—É—Ä—Å—ã Pod (requests/limits)**
* **HPA –ø–æ CPU + VPA –ø–æ CPU ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç**
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ:

  * HPA –ø–æ –∫–∞—Å—Ç–æ–º–Ω–æ–π –º–µ—Ç—Ä–∏–∫–µ, VPA –ø–æ CPU/memory
  * –ò–ª–∏ HPA –ø–æ CPU, VPA **—Ç–æ–ª—å–∫–æ –ø–æ memory**
* VPA —Ä–µ–∂–∏–º **Initial / InPlaceOrRecreate**
* `describe` –æ–±–æ–∏—Ö ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ recommendations / events
* –í–º–µ—Å—Ç–µ –¥–∞—é—Ç **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã + –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–ª–∏–∫**
