Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"

  # Disable automatic box update checking
  config.vm.box_check_update = false

  # Provider configuration for libvirt
  config.vm.provider :libvirt do |libvirt|
    libvirt.driver = "kvm"
    libvirt.cpu_mode = "host-passthrough"
  end

  # Define the number of nodes
  NUM_MASTERS = 3
  NUM_WORKERS = 3

  # Method to copy directory from host to VM
  def copy_directory(config, source_path, dest_path = "/tmp/")
    config.vm.provision "file", 
      source: source_path,
      destination: dest_path,
      type: "rsync"  # Use rsync for better performance with directories
  end

  # Create HAproxy Lb
  config.vm.define "lb" do |lb|
    lb.vm.hostname = "k8s-lb"
    lb.vm.network :private_network, ip: "192.168.57.10"
    lb.vm.network "forwarded_port",
      guest: 9000,
      host: 9000,
      auto_correct: true
    lb.vm.network "forwarded_port",
      guest: 6443,  # Kubernetes API
      host: 6443,
      auto_correct: true

    lb.vm.provider :libvirt do |node|
      node.memory = 2048
      node.cpus = 3
      node.storage :file, :size => '10G'
    end

    # Copy bootstrap scripts
    lb.vm.provision "file", source: "bootstrap/lb-setup.sh", destination: "/tmp/lb-setup.sh"
    
    # Example: Copy entire kubespray directory
    # copy_directory(lb, "../kubespray", "/opt/kubespray")
    
    # Bootstrap script for lb
    lb.vm.provision "shell", inline: <<-SHELL
      #!/bin/bash
      chmod +x /tmp/lb-setup.sh
      /tmp/lb-setup.sh
    SHELL
  end

  # Create master nodes
  (1..NUM_MASTERS).each do |i|
    config.vm.define "master-#{i}" do |master|
      master.vm.hostname = "master-#{i}"
      master.vm.network :private_network, ip: "192.168.57.#{20 + i}"

      master.vm.provider :libvirt do |node|
        node.memory = 4096  # Increased for master nodes
        node.cpus = 3
        node.storage :file, :size => '15G'  # Increased storage
      end

      # Copy setup script to VM
      master.vm.provision "file", source: "bootstrap/full.sh", destination: "/tmp/bootstrap.sh"
      master.vm.provision "file", source: "bootstrap/prepare-expired-certs.sh", destination: "/tmp/prepare-expired-certs.sh"
      master.vm.provision "file", source: "bootstrap/restore-normal-time.sh", destination: "/tmp/restore-normal-time.sh"

      # Copy kubespray directory (example)
      # copy_directory(master, "../kubespray", "/opt/kubespray")

      # Bootstrap script for master
      master.vm.provision "shell", inline: <<-SHELL
        #!/bin/bash
        echo "=== Setting up K8s Master Node ==="
        chmod +x /tmp/bootstrap.sh
        /tmp/bootstrap.sh master
      SHELL

      # Additional shell provisioner for kubespray setup
      master.vm.provision "shell", inline: <<-SHELL
        #!/bin/bash
        echo "=== Installing kubespray prerequisites ==="
        apt-get update
        apt-get install -y python3-pip python3-venv git
      SHELL
    end
  end

  # Create worker nodes
  (1..NUM_WORKERS).each do |i|
    config.vm.define "worker-#{i}" do |worker|
      worker.vm.hostname = "worker-#{i}"
      worker.vm.network :private_network, ip: "192.168.57.#{30 + i}"

      worker.vm.provider :libvirt do |node|
        node.memory = 4096  # Increased for worker nodes
        node.cpus = 3
        node.storage :file, :size => '20G'  # More storage for workloads
      end

      # Copy setup script to VM
      worker.vm.provision "file", source: "bootstrap/full.sh", destination: "/tmp/bootstrap.sh"
      worker.vm.provision "file", source: "bootstrap/prepare-expired-certs.sh", destination: "/tmp/prepare-expired-certs.sh"
      worker.vm.provision "file", source: "bootstrap/restore-normal-time.sh", destination: "/tmp/restore-normal-time.sh"

      # Copy kubespray directory (example)
      # copy_directory(worker, "../kubespray", "/opt/kubespray")

      # Bootstrap script for worker
      worker.vm.provision "shell", inline: <<-SHELL
        #!/bin/bash
        echo "=== Setting up K8s Worker Node ==="
        chmod +x /tmp/bootstrap.sh
        /tmp/bootstrap.sh worker
      SHELL
    end
  end

  # Optional: Sync folder for shared data (alternative to file provisioner)
  config.vm.synced_folder "../kubespray", "/vagrant/kubespray", 
    type: "rsync",
    rsync__exclude: [".git/", "*.swp", ".vagrant/"]
  
  # Optional: Global shell provisioner to run on all nodes
  config.vm.provision "shell", inline: <<-SHELL
    #!/bin/bash
    echo "=== Setting hostname and hosts ==="
    cat >> /etc/hosts <<EOF
192.168.57.10   k8s-lb
192.168.57.21   master-1
192.168.57.22   master-2
192.168.57.23   master-3
192.168.57.31   worker-1
192.168.57.32   worker-2
192.168.57.33   worker-3
EOF
  SHELL
end
